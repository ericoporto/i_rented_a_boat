// room script file
Vec3* _sign_pos;
Vec3* _key_pos;
float _scale_height;

void _AdjustDarkPoster()
{
  if(!(Player_Pos.x > 169.0 && Player_Pos.x <463.0 && Player_Pos.y > 389.0 && Player_Pos.y < 509.0))
  {
    cDarkPoster.Transparency = 100;
    return;
  }
  
  CharacterProjectionAdjust(cDarkPoster, _scale_height, _sign_pos);
  if(cDarkPoster.Transparency != 100) {
    cDarkPoster.Scaling = ClampI(cDarkPoster.Scaling / 2, 5, 200);
    cDarkPoster.Tint(65, 48, 32,  90, ClampI(cDarkPoster.Scaling, 0, 100));
    cDarkPoster.Transparency = ClampI(25-cDarkPoster.Scaling/4, 0, 100);
  }
  
  if(!player.HasInventory(iKey))
  {
    ScreenPoint* sp = CharacterProjectionAdjust(cCaveKey, _scale_height, _key_pos);
    if(cCaveKey.Transparency != 100) {
      cCaveKey.Transparency = obj_fulloverdark.Transparency;
      if(cCaveKey.Transparency > 85) cCaveKey.Transparency = 100;
      cCaveKey.LockViewFrame(VIEW_ROTATING_KEY, 0,  ClampLoopI(cCaveKey.Frame + 1, 0, 15));
      hHotspot5.SetTextProperty("aName","Collect Key");
    } else {
      hHotspot5.SetTextProperty("aName","");  
    }
  }
  
}

function room_Load()
{
  cBgRoom.Baseline = 40;
  cDarkPoster.Baseline = 50;
  _scale_height = 64.0;
  Flashlight_SetObject(obj_flashlight);
  Sound_AmbientPlay(aAmb_cave);
  player.x = 16;
  player.y = 16;
  _sign_pos = Vec3.Create(390.0, 450.0, 12.0);
  _key_pos = Vec3.Create(320.0, 429.0, 12.0);
  
  if(!(player.x > 169 && player.x <463 && player.y > 389 && player.y < 509)) {
    cDarkPoster.Transparency = 100;
    cCaveKey.Transparency = 100;
  }
}

function room_AfterFadeIn()
{
  CustomTransition_FadeIn(0.33, eBlockTween);
  if(Game.DoOnceOnly("save_first_time_in_cave"))
  {
    Wait(1);
    CustomSave.doAutoSave();
  }
}

function room_RepExec()
{

}

float  _FlashlightAdjust()
{
  float percent_flash =  GetFlashLightRaised();
  float color_mix = 68.0 - percent_flash*24.0;
  int black_transp = FloatToInt(percent_flash*100.0);
  obj_overdark.Transparency = ClampI(100 - black_transp, 0, 100);
  obj_fulloverdark.Transparency = ClampI(black_transp, 0, 100);
 
  return color_mix;
}

// add different colors in each way
// add shades on top

function repeatedly_execute_always()
{ 

  if(Frame & 4) return;
  _AdjustDarkPoster();
  
  float color_mix = _FlashlightAdjust();
  RenderCurrentMapAsCave(_scale_height, 448.0, color_mix);  
}

function hHotspot22_Interact()
{
  if(Player_Angle < -2.8 || Player_Angle > 2.6)
  {
    if(bool_balloon_in_position)
    {
      // end game
      CustomTransition_FadeOut(0.5, eBlockTween, 0.0, eAgsColor_White);
      player.ChangeRoom(33, 196, 218);      
    }
    else 
    {
      CustomTransition_FadeOut(0.25, eBlockTween, 0.0, eAgsColor_White);
      player.ChangeRoom(1, 196, 218);
    }
  }
}

function hHotspot21_Interact()
{
  CustomTransition_FadeOut(0.25, eBlockTween, 0.0, eAgsColor_White);
  player.ChangeRoom(3, 314, 411);
}

function hHotspot20_Interact()
{
  CustomTransition_FadeOut(0.25, eBlockTween, 0.0, eAgsColor_White);
  player.ChangeRoom(4, 756, 337);
}

function hHotspot5_Interact()
{
  if(!player.HasInventory(iKey) && cCaveKey.Transparency < 60)
  {
    player.AddInventory(iKey);
    hHotspot5.SetTextProperty("aName","");
    cCaveKey.Transparency = 100;
    hHotspot5.Enabled = false;
  }
}
